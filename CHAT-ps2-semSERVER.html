<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <title>NÚCLEO X+Y | TÚNEL P2P</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        .panel { border: 1px solid #0f0; padding: 15px; margin-bottom: 10px; background: #010; }
        textarea { width: 100%; background: #000; color: #0f0; border: 1px dashed #050; height: 80px; font-size: 10px; resize: none; }
        .status { font-size: 12px; color: #0a0; margin-bottom: 10px; text-transform: uppercase; }
        .btn { background: #000; border: 1px solid #0f0; color: #0f0; padding: 10px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 5px; }
        .btn:hover { background: #0f0; color: #000; box-shadow: 0 0 15px #0f0; }
        #chat { flex-grow: 1; border: 1px solid #0f0; overflow-y: auto; padding: 10px; margin-top: 10px; background: #000; }
        .msg { margin-bottom: 8px; border-left: 2px solid #0f0; padding-left: 5px; }
        .msg.me { border-left-color: #050; color: #0a0; }
        input[type="text"] { width: 100%; background: #000; border: 1px solid #0f0; color: #0f0; padding: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="status">[ ESTADO: <span id="status">AGUARDANDO INÍCIO</span> ]</div>
        <button class="btn" onclick="criarOferta()">1. GERAR CONVITE DE TÚNEL</button>
        <textarea id="sdp-local" placeholder="Código do teu túnel aparecerá aqui..."></textarea>
    </div>

    <div class="panel">
        <button class="btn" onclick="conectar()">2. VALIDAR CHAVE RECEBIDA</button>
        <textarea id="sdp-remoto" placeholder="Cola aqui o código que o outro humano te enviou..."></textarea>
    </div>

    <div id="chat"></div>
    <input type="text" id="input-msg" placeholder="Escreve no túnel e prime ENTER..." onkeypress="verificarEnter(event)">

    <script>
        let pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        let canal;

        // Configura o canal de dados
        function configurarCanal(c) {
            canal = c;
            canal.onopen = () => {
                document.getElementById('status').innerText = "TÚNEL ATIVO (DIRETO)";
                document.getElementById('status').style.color = "#fff";
                addMsg("SISTEMA", "Conexão P2P estabelecida. Sem servidores.");
            };
            canal.onmessage = e => addMsg("OUTRO", e.data);
        }

        // Criar o convite (Oferta)
        async function criarOferta() {
            const dataChannel = pc.createDataChannel("chat");
            configurarCanal(dataChannel);

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Aguarda os candidatos ICE (para funcionar fora da rede local)
            pc.onicecandidate = (event) => {
                if (!event.candidate) {
                    document.getElementById('sdp-local').value = btoa(JSON.stringify(pc.localDescription));
                    document.getElementById('status').innerText = "CONVITE GERADO. ENVIA AO PARCEIRO.";
                }
            };
        }

        // Conectar usando a chave do outro (Resposta ou Oferta)
        async function conectar() {
            const rawData = document.getElementById('sdp-remoto').value;
            const sdp = JSON.parse(atob(rawData));

            if (sdp.type === "offer") {
                pc.ondatachannel = (event) => configurarCanal(event.channel);
                await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                pc.onicecandidate = (event) => {
                    if (!event.candidate) {
                        document.getElementById('sdp-local').value = btoa(JSON.stringify(pc.localDescription));
                        alert("CHAVE DE RESPOSTA GERADA! Envia de volta para o primeiro humano.");
                    }
                };
            } else {
                await pc.setRemoteDescription(new RTCSessionDescription(sdp));
            }
        }

        function enviar() {
            const input = document.getElementById('input-msg');
            if (canal && canal.readyState === "open" && input.value) {
                canal.send(input.value);
                addMsg("EU", input.value);
                input.value = "";
            }
        }

        function addMsg(autor, texto) {
            const div = document.createElement('div');
            div.className = "msg " + (autor === "EU" ? "me" : "");
            div.innerText = `[${autor}]: ${texto}`;
            const chat = document.getElementById('chat');
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function verificarEnter(e) { if (e.key === 'Enter') enviar(); }
    </script>
</body>
</html>